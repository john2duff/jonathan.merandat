<!doctype html>
<html lang="fr">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <meta charset="UTF-8">
        <title>Générateur de tournoi de Badminton</title>
        <style>
           
            .itemList {
                display: flex;
                flex-direction: row;
                padding: 10px;
                background-color: white;
                /* border-radius: 5px; */
                margin: 10px;
                flex-wrap: wrap;
                box-shadow: 4px 5px 11px 1px #c3c3c3;
            }
            .allParamItem {
                display: flex;
                flex: 1 1 auto;
                flex-wrap: wrap;
                flex-direction: row;
            }
            .paramItem {
                display: flex;
                flex-direction: column;
                justify-content: center;
                margin: 0px 5px;
                width: 100px;
            }
            .labelParamItem{
                color: gray;
                font-size: 0.7em;
                margin: 0px;
                padding-left: 5px;
            }
            .valueParamItem{
                color:black;
                font-size: 1em;
                padding:5px;
            }

            #logoBadLevier{
                max-height: 50px;
            }

            .barItem{
                background-color: #e3e3e3;
                padding: 10px;
                display:flex;
                flex-direction:row;
                justify-content:space-between;
                flex:1 1 auto;
            }
            .barItemInterface{
                margin: 0px 5px;
            }
            .titleBarItem{
                margin-left: 10px;
                margin-bottom: 0px;
            }
            .sensInverse{
                flex-direction: column;
                flex-wrap: initial;
            }
            .popup {
                display: flex;
                flex-direction: column;

            }
            .bodyPopup{
                flex: 1 1 auto;
                overflow: auto;
            }
            .headerPopup{
                background-color: gray;
                padding: 10px;
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }
            .titleHeaderPopup{
                margin-bottom: 0px;
            }
            .footerPopup{
                background-color: gray;
            }
            .popupMask {
                background-color: rgb(0 0 0 / 60%);
                position: fixed;
                width: 100%;
                height: 100%;
                top: 0px;
                left: 0px;
                z-index: 1031;
                justify-content: center;
                align-items: center;
                display: none;
            }
            .popupView{
                width: 80%;
                height: 80%;
                margin: auto;
                background-color: #bbbbbb;
                border-radius: 5px;
            }
        </style>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    </head>
    <body onload="refresh();">

        <div id="header" class="container">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <img id="logoBadLevier" class="rounded mx-auto d-block img-thumbnail" href="#" src="./img/logoBadLevier.jpg"/>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item dropdown" >
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Import/Export
                            </a>
                            <div class="dropdown-menu" style="z-index:1030;" aria-labelledby="navbarDropdownMenuLink">
                                <label class="dropdown-item btn-file">
                                    Import <input id="bdTournoi" type="file" accept=".json" style="display: none;">
                                </label>
                                <label class="dropdown-item" onclick="exportTournoi();">
                                    Export 
                                </label>
                            </div>
                        </li>
                    </ul>
                </div>

                
            </nav>
        </div>
        
        <div id="global" class="container-fluid"></div>
        <div id="popupMask" class="popupMask">
            <div id="popupView" class="popupView"></div>
        </div>

        <script>

        //configuration du logiciel
        var mainConfig = {
            "nativeTypes": ["string", "integer"],
            "fixedObjects": {
                "dataBaseName": {
                    "title": "Nom base de données", 
                    "desc": "Nom du fichier base de données" ,
                    "type": "string", 
                    "datas" : "generateurTournoi" },
                "genre": { 
                    "title": "Genre", 
                    "desc": "Etes-vous un homme ou une femme ?",
                    "type": "array>string",
                    "datas": ["Homme", "Femme"] },
                "niveau": {
                    "title": "Niveau", 
                    "desc": "Le niveau du joueur", 
                    "type": "array>string",
                    "datas": ["P12", "P11", "P10"] },
                "typeTournoi": {
                    "title": "Type de tournoi", 
                    "desc": "Il peut s'agir d'un tournoi simple ou double", 
                    "type": "array>string",
                    "datas": ["Simple", "Double"] },
                "nombreTour": {
                    "title": "Nombre de tour", 
                    "desc": "Combien de tour va-t-on faire ?", 
                    "type": "integer",
                    "datas": ["0-10"] }
            },
            "dynObjects": { //représente tous les objets à stocker
                "joueur": {
                    "title": "Joueur",
                    "desc": "Joueur de badminton",
                    "type": "object",
                    "datas": [
                        ["Nom", "string", "Ton petit nom"],
                        ["Prénom", "string", "Ton petit prénom"],
                        ["Genre", "genre"], 
                        ["Niveau", "niveau"]
                    ]
                }, 
                "preparation": {
                    "title": "Préparation", 
                    "desc": "Préparation du tournoi", 
                    "type": "object",
                    "datas": [
                        ["Type tournoi", "typeTournoi", "Le type du tournoi"],
                        ["Nombre de tour", "nombreTour", "Le nombre de tour"]
                    ]
                }
            }, 
            "views": {
                "joueurs": {
                    "title": "Joueurs",
                    "desc": "Il s'agit de la liste de tous les joueurs",
                    "type": "array>joueur",
                    "actions": ["add", "remove", "edit", "sensRevert"], 
                    "sens": true
                }, 
                "preparation": {
                    "title": "Préparation",
                    "type": "preparation",
                    "actions": ["edit", "sensRevert"], 
                    "sens": true
                }
            },
            
        }

        var globalDiv = document.getElementById("global");
        var popupMask = document.getElementById("popupMask");
        var popupDiv = document.getElementById("popupView");
        
//----------View
            var TABLEAU = "Tableau";
            var FORMULAIRE = "Formulaire";
            var currentModeAffichage = TABLEAU;

            window.addEventListener("resize", function(){
                refresh();
            });

            function refreshModeAffichage(){
                currentModeAffichage = window.innerWidth > 500 ? TABLEAU : FORMULAIRE; 
            }

            function refresh(){
                refreshModeAffichage();
                for (var viewName in mainConfig["views"]){
                    refreshView(mainConfig["views"][viewName], viewName);
                }
            }

            function refreshView(view, viewName){
                var domView = initView(viewName);
                domView.innerHTML = "";
                var dimension = view["type"].includes("array>") ? 2 : 1;
                domView.appendChild(buildBarItem(view, viewName, dimension));
                domView.appendChild(buildView(view, viewName, dimension, false));
            }

            function initView(viewName) {
                var domView = document.getElementById(viewName); 
                if (domView == null){
                    domView = buildElement("div", undefined, viewName, "container");
                    globalDiv.appendChild(domView);
                }
                domView.innerHTML = "";
                return domView;
            }

            function buildView(view, viewName, dimension, modeEdition) {
                var type = view["type"];
                var typeArray = type.includes("array>");
                var dynObj = getBDItem(viewName);

                //s'il s'agit d'un type primitif
                if (mainConfig["nativeTypes"].includes(type)) {
                    return buildNativeType(dynObj);
                } else {
                    //si le type a été définie dans les objets fixes (en dur dans le code)
                    if (mainConfig["fixedObjects"][type] != undefined) {

                    }
                    //objet stocké (persistents) 
                    else {
                        var mdd;
                        if (dimension == 2) {
                            type = type.split(">")[1]; //on récupére le type dans le tableau
                            mdd = mainConfig["dynObjects"][type];
                            return buildArray(view, viewName, mdd, dynObj, dimension, modeEdition);
                        }else {
                            mdd = mainConfig["dynObjects"][type];
                            return buildArray(view, viewName, mdd, dynObj, dimension, modeEdition);
                        }
                    }
                }               
            }

            //Construit l'entête de la vue
            function buildBarItem(view, viewName, dimension){
                var divTitre = buildElement("div", undefined, undefined, "sticky-top barItem");
                divTitre.setAttribute("title", view["desc"]);
                var titre = buildElement("h4", view["title"], undefined, "titleBarItem");
                divTitre.appendChild(titre);
                var divInterfaces = buildElement("div");
                if (view["actions"].includes("sensRevert")) 
                    divInterfaces.appendChild(buildInverse(viewName));
                if (view["actions"].includes("edit") && dimension == 1)
                    divInterfaces.appendChild(buildEdit(view, viewName, mainConfig["dynObjects"][view["type"]], getBDItem(viewName)));
                divTitre.appendChild(divInterfaces);
                return divTitre;
            }
            
            //construit une liste d'élement à deux dimensions
            function buildArray(view, viewName, mdd, dynObj, dimension, modeEdition){
                if (currentModeAffichage == FORMULAIRE || modeEdition) {
                    return buildListForm(view, viewName, mdd, dynObj, dimension, modeEdition);
                }else {
                    return buildTable(view, viewName, mdd, dynObj, dimension);
                }
            }

            function buildNativeType(dynObj){
                return buildElement("span", dynObj);
            }

            function buildInverse(viewName){
                var buttonInverse = buildElement("button", "Inverser", undefined, "btn btn-light barItemInterface");
                buttonInverse.setAttribute("onclick", "inverseSens('" + viewName + "');");
                buttonInverse.value = "Inverse";
                return buttonInverse;
            }

            function buildEdit(view, viewName, mdd, dynObj){
                var buttonEdition = buildElement("button", "Editer", undefined, "btn btn-light barItemInterface");
                buttonEdition.onclick = edit.bind(this, view, viewName, mdd, dynObj);
                buttonEdition.value = "Editer";
                return buttonEdition;
            }

            function refreshPopup(actionName, view, viewName, mdd, dynObj){
                popupDiv.innerHTML = "";
                popupDiv.innerHTML = buildPopup(actionName, view, viewName, mdd, dynObj).innerHTML;
            }

            function buildPopup(actionName, view, viewName, mdd, dynObj, dimension) {
                var popup = buildElement("div", undefined, "popupEdition", "popup");

                popup.appendChild(buildHeaderPopup(actionName, view, viewName, mdd, dynObj, dimension));

                var bodyPopup = buildElement("div", undefined, undefined, "bodyPopup");
                bodyPopup.appendChild(buildListForm(view, viewName, mdd, dynObj, dimension, true));
                popup.appendChild(bodyPopup);

                popup.appendChild(buildFooterPopup(actionName, view, viewName, mdd, dynObj, dimension));
                return popup;
            }

            function buildHeaderPopup(actionName, view, viewName, mdd, dynObj, dimension){
                var headerPopup = buildElement("div", undefined, undefined, "headerPopup");
                var title = buildElement("h4", actionName, undefined, "titleHeaderPopup");
                headerPopup.appendChild(title);
                return headerPopup;
            }
            function buildFooterPopup(actionName, view, viewName, mdd, dynObj, dimension){
                var footerPopup = buildElement("div", undefined, undefined, "footerPopup");

                return footerPopup;
            }

            function popupIsVisible(){
                return popupMask.style["display"] != "none";
            }

            function showPopup(actionName, view, viewName, mdd, dynObj){
                refreshPopup(actionName, view, viewName, mdd, dynObj);
                popupMask.style["display"] = "flex";
            }

            function hidePopup(){
                popupMask.style["display"] = "none";
            }

//---------- ACTION 

            function inverseSens(viewName){
                mainConfig["views"][viewName]["sens"] = !mainConfig["views"][viewName]["sens"];  
                refresh();
            }
            function edit(view, viewName, mdd, dynObj){
                showPopup("Modification", view, viewName, mdd, dynObj);
            }

            /****  CREATION TABLE  ******/
            {

                function buildTable (view, viewName, mdd, dynObj, dimension){
                    var currentTr;
                    var table = buildElement("table", undefined, undefined, "table");
                    var thead = buildElement("thead", undefined, undefined, "headerListTableau");
                    var tbody = buildElement("tbody", undefined, undefined, "bodyListTableau");
                    var dim1 = dimension == 1;
                    var dim2 = dimension == 2;
                
                    if (dim1){
                        if (view["sens"]){
                            //remplissage du header
                            currentTr = buildElement("tr");
                            for (var i = 0; i < mdd["datas"].length; i++){
                                currentTr.appendChild(this.buildHeaderCell(mdd["datas"][i]));
                            }
                            thead.appendChild(currentTr);
                            //remplissage du body
                            currentTr = buildElement("tr");
                            for (var i = 0; i < dynObj.length; i++){
                                currentTr.appendChild(this.buildBodyCell(dynObj[i]));
                            }  
                            tbody.appendChild(currentTr);
                        } else{
                            //remplissage du body
                            for (var i = 0; i < dynObj.length; i++){
                                currentTr = buildElement("tr");
                                currentTr.appendChild(this.buildHeaderCell(mdd["datas"][i]));
                                currentTr.appendChild(buildBodyCell(dynObj[i]));
                                tbody.appendChild(currentTr);
                            }
                        }
                    }else if (dim2){
                        var editable = view["actions"].includes("edit");
                        if (view["sens"]){
                            //remplissage du header
                            currentTr = buildElement("tr");
                            for (var i = 0; i < mdd["datas"].length; i++){
                                currentTr.appendChild(this.buildHeaderCell(mdd["datas"][i]));
                            }
                            if (editable) currentTr.appendChild(buildElement("th"));
                            thead.appendChild(currentTr);
                            //remplissage du body
                            for (var i = 0; i < dynObj.length; i++){
                                currentTr = buildElement("tr");
                                for (var k = 0; k < dynObj[i].length; k++){
                                    currentTr.appendChild(this.buildBodyCell(dynObj[i][k]));
                                }
                                if (editable) {
                                    var td = buildElement("td");
                                    td.appendChild(buildEdit(view, viewName, mdd["datas"], dynObj[i]));
                                    currentTr.appendChild(td); 
                                }
                                tbody.appendChild(currentTr);
                            }
                        }else{
                            //remplissage du body
                            for (var i = 0; i < mdd["datas"].length; i++){
                                currentTr = buildElement("tr");
                                currentTr.appendChild(this.buildHeaderCell(mdd["datas"][i]));
                                for (var j = 0; j < dynObj[i].length; j++){
                                    currentTr.appendChild(this.buildBodyCell(dynObj[i][j]));
                                }
                                tbody.appendChild(currentTr);
                            }
                        }
                    }
                    table.appendChild(thead);
                    table.appendChild(tbody);
                    return table;
                }

                function buildHeaderCell(mdd){
                    currentTd = buildElement("th", mdd[0]);
                    currentTd.setAttribute("type", mdd[1]);
                    currentTd.setAttribute("title", mdd[2]);
                    return currentTd;
                }

                function buildBodyCell(dynObj) {
                        return buildElement("td", dynObj);
                }
            
            }

            /****  CREATION FORMULAIRE  ******/
            {
                function buildListForm(view, viewName, mdd, dynObj, dimension, editionMode){
                    var dim1 = dimension == 1;
                    var dim2 = dimension == 2;
                    var styleSensInverse = view["sens"] ? "" : "sensInverse ";
                    var divRetour = buildElement("div");

                    if (dim1) {
                        divRetour = buildElement("div");
                        var divAllParams;
                        div = buildElement("div", "", undefined, "itemList " + styleSensInverse);
                        divAllParams = buildElement("div", "", "allParamItem" + i, "allParamItem " + styleSensInverse);
                        for (var i = 0; i < dynObj.length; i++){
                            divAllParams.appendChild(this.buildItemForm(mdd["datas"][i], dynObj[0], editionMode));
                        }
                        div.appendChild(divAllParams);
                        divRetour.appendChild(div);

                    } else if (dim2) {
                        divRetour = buildElement("div");
                        var divAllParams;
                        for (var i = 0; i < dynObj.length; i++){
                            div = buildElement("div", "", undefined, "itemList " + styleSensInverse);
                            divAllParams = buildElement("div", "", "allParamItem" + i, "allParamItem " + styleSensInverse);
                            for (var j = 0; j < dynObj[i].length; j++){
                                divAllParams.appendChild(this.buildItemForm(mdd["datas"][j], dynObj[i][j], editionMode));
                            }
                            if (view["actions"].includes("edit")) 
                                divAllParams.appendChild(buildEdit(view, viewName, mdd["datas"][i], dynObj[i]));
                            div.appendChild(divAllParams);
                            divRetour.appendChild(div);
                        }
                    }
                    return divRetour;
                }

                //construire l'affichage d'un item dans une liste
                function buildItemForm(mdd, dynObj, editionMode){
                    var divParam = buildElement("div", "", undefined, "paramItem");
                    var label = buildElement("label", mdd[0], undefined, "labelParamItem");
                    label.setAttribute("type", mdd[1]);
                    divParam.appendChild(label);
                    if (editionMode){
                        var input;
                        if (mdd["type"] == "string") {
                            input = buildElement("input", undefined, undefined, "valueParamItem");
                            input.value = dynObj;
                            input.placeholder = mdd["desc"];
                        }
                        divParam.appendChild(input);                    
                    }else {
                        divParam.appendChild(buildElement("span", dynObj, undefined, "valueParamItem"));                    
                    }
                    return divParam;
                }
            }

            function buildElement(type, innerHTML, id, className){
                var elt = document.createElement(type);
                if (id != undefined) elt.setAttribute("id", id);
                if (className != undefined) elt.setAttribute("class", className);
                if (innerHTML != undefined) elt.innerHTML = innerHTML;
                return elt;
            }   

 
            
//----------Model BD

            //Récupérer toute la base de donnée
            function getBDItem(key, source){
                if (source == undefined) source = localStorage.getItem(mainConfig["nomBd"]);
                source = JSON.parse(source);           
                return getBDItemRecursif(source, key);
            }
            

            function getBDItemRecursif(source, key){
                for (var i in source) {
                    if (i == key){
                        return source[i];
                    }else if (typeof(source[i]) == "object"){
                        var retour = getBDItemRecursif(source[i], key);
                        if (retour != null) return retour;
                    }
                }
                return null;
            }

            function saveBD(source){
                localStorage.setItem(mainConfig["nomBd"], JSON.stringify(source));
            }

            function saveBDItem(item){
                var all;
                if (item == "joueur") {
                    all += JSON.parse(item);
                } else{
                    all += JSON.parse(getBDItem("joueur"));
                }
                saveBD(all);
            }

            var importDatas;
            //import
            document.getElementById("bdTournoi").addEventListener('change', function() {   
                var fichier = new FileReader(); 
                fichier.onload = function() { 
                    var json = JSON.parse(fichier.result);
                    saveBD(json);
                    refresh();
                }   
                fichier.readAsText(this.files[0]); 
            });

            function exportTournoi() {
                downloadFile(localStorage.getItem(mainConfig["nomBd"]));
            }

            function downloadFile(data, name, type){
                name = "tournoi - " + new Date();
                type = "application/json";
                var anchor = document.createElement("a");
                anchor.href = window.URL.createObjectURL(new Blob([data], {type}));
                anchor.download = name;
                anchor.click();
            }
            
        </script>

        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    </body> 

</html>


